const postContext={limited:!1,initReadLimit(){if(PageAttrs.metas.enable_read_limit&&"true"!==PageAttrs.metas.enable_read_limit.trim())return;postContext.limited=!0;const $article=$(".page-post .joe_detail__article"),$content=$("#post-inner"),$hideMark=$(".page-post .joe_read_limited"),clientHeight=document.documentElement.clientHeight||document.body.clientHeight,cid=$(".joe_detail").attr("data-cid"),removeLimit=()=>{postContext.limited=!1,$hideMark.parent().remove(),$article.removeClass("limited"),postContext.initToc(!0)};if($content.height()<clientHeight+180)return void removeLimit();const checkPartialIds=(postId,cb)=>{const localIds=localStorage.getItem("partialIds");localIds&&localIds.includes(postId)?removeLimit():cb&&cb()},updateState=async()=>{const scrollTop=$hideMark.offset().top-180,localIds=localStorage.getItem("partialIds");await Utils.sleep(800),removeLimit(),localStorage.setItem("partialIds",localIds?localIds+","+cid:cid),Qmsg.success("感谢您的支持"),$("html,body").animate({scrollTop:scrollTop},500)};checkPartialIds(cid,()=>{document.getElementsByTagName("halo-comment")[0].addEventListener("post-success",_data=>{checkPartialIds(cid,updateState)})})},initCopy(){if("false"===PageAttrs.metas.enable_copy||!ThemeConfig.enable_copy)return;const curl=location.href,author=$(".joe_detail").attr("data-author");$(".joe_detail__article").on("copy",(function(e){const selection=window.getSelection(),selectionText=selection.toString().replace(/<已自动折叠>/g,""),appendLink=ThemeConfig.enable_copy_right_text?ThemeConfig.copy_right_text||`\r\n\r\n====================================\r\n文章作者： ${author}\r\n文章来源： ${ThemeConfig.blog_title}\r\n文章链接： ${curl}\r\n版权声明： 内容遵循 CC 4.0 BY-SA 版权协议，转载请附上原文出处链接及本声明。`:"";if(window.clipboardData){const copytext=selectionText+appendLink;return window.clipboardData.setData("Text",copytext),!1}{const body_element=document.body,copytext=selectionText+appendLink,newdiv=document.createElement("pre");newdiv.style.position="absolute",newdiv.style.left="-99999px",body_element.appendChild(newdiv),newdiv.innerText=copytext,selection.selectAllChildren(newdiv),setTimeout((function(){body_element.removeChild(newdiv)}),0)}}))},initShare(){"false"!==PageAttrs.metas.enable_share&&ThemeConfig.enable_share&&(ThemeConfig.enable_share_link&&$(".icon-share-link").length&&$(".icon-share-link").each((_index,item)=>{new ClipboardJS($(item)[0],{text:()=>location.href}).on("success",()=>Qmsg.success("文章链接已复制"))}),ThemeConfig.enable_share_weixin&&$(".qrcode_wx").length&&$(".qrcode_wx").qrcode({width:140,height:140,render:"canvas",typeNumber:-1,correctLevel:0,background:"#ffffff",foreground:"#000000",text:location.href}))},initLike(){if("false"===PageAttrs.metas.enable_like||!ThemeConfig.enable_like||!$(".joe_detail__agree").length)return;const cid=$(".joe_detail").attr("data-cid"),clikes=+($(".joe_detail").attr("data-clikes")||0);let agreeArr=localStorage.getItem(encryption("agree"))?JSON.parse(decrypt(localStorage.getItem(encryption("agree")))):[],flag=agreeArr.includes(cid);const $icons=$(".joe_detail__agree, .post-operate-like"),$iconLike=$icons.find(".icon-like"),$iconUnlike=$icons.find(".icon-unlike"),$likeNum=$icons.find(".nums");flag?$iconUnlike.addClass("active"):$iconLike.addClass("active"),$likeNum.html(clikes);let _loading=!1;$iconLike.on("click",(function(e){e.stopPropagation(),_loading||(_loading=!0,agreeArr=localStorage.getItem(encryption("agree"))?JSON.parse(decrypt(localStorage.getItem(encryption("agree")))):[],flag=agreeArr.includes(cid),Utils.request({url:"/api/content/posts/"+cid+"/likes",method:"POST",data:{type:flag?"disagree":"agree"}}).then(_res=>{let likes=clikes;if(flag){likes--;const index=agreeArr.findIndex(_=>_===cid);agreeArr.splice(index,1),$iconUnlike.removeClass("active"),$iconLike.addClass("active"),$icons.removeClass("active")}else likes++,agreeArr.push(cid),$iconLike.removeClass("active"),$iconUnlike.addClass("active"),$icons.addClass("active");const name=encryption("agree"),val=encryption(JSON.stringify(agreeArr));localStorage.setItem(name,val),$likeNum.html(likes).show()}).catch(err=>{_loading=!1}))}))},initToc(reload){if("false"===PageAttrs.metas.enable_toc||!ThemeConfig.enable_toc||!$(".toc-container").length)return;if("true"===PageAttrs.metas.use_raw_content)return $("#js-toc").html('<div class="toc-nodata">暂不支持解析原始内容目录</div>'),void $(".toc-container").show();if("true"===PageAttrs.metas.enable_read_limit&&!reload&&postContext.limited)return $("#js-toc").html('<div class="toc-nodata">文章内容不完整，目录仅评论后可见</div>'),void $(".toc-container").show();const $html=$("html"),$mask=$(".joe_header__mask"),$btn_mobile_toc=$(".joe_action .toc"),$mobile_toc=$(".joe_header__toc"),$tocContainer=$("#js-toc, #js-toc-mobile");tocbot.init({tocSelector:Joe.isMobile?"#js-toc-mobile":"#js-toc",contentSelector:".joe_detail__article",ignoreSelector:".js-toc-ignore",headingSelector:"h1,h2,h3,h4,h5,h6",collapseDepth:+(PageAttrs.metas.toc_depth||ThemeConfig.toc_depth||0),scrollSmooth:!0,includeTitleTags:!0,hasInnerContainers:!1,headingsOffset:80,scrollSmoothOffset:-80,positionFixedSelector:".toc-container",positionFixedClass:"is-position-fixed",fixedSidebarOffset:"auto",onClick:function(e){Joe.isMobile&&($html.removeClass("disable-scroll"),$mobile_toc.removeClass("active"),$mask.removeClass("active slideout")),window.tocPhase=!0},scrollEndCallback:function(e){window.tocPhase=null}}),$tocContainer.children().length||$tocContainer.html(Joe.isMobile?'<div class="toc-nodata"><em></em>暂无目录</div>':'<div class="toc-nodata">暂无目录</div>'),Joe.isMobile&&($btn_mobile_toc.show(),$btn_mobile_toc.on("click",()=>{window.sessionStorage.setItem("lastScroll",$html.scrollTop()),$html.addClass("disable-scroll"),$mask.addClass("active slideout"),$mobile_toc.addClass("active")})),$(".toc-container").show()},initAsideOperate(){if($(".post-operate-comment").on("click",(function(e){const $comment=document.querySelector(".joe_comment"),$header=document.querySelector(".joe_header");if(!$comment||!$header)return;if(e.stopPropagation(),!document.getElementsByTagName("halo-comment").length)return void Qmsg.warning("评论功能不可用！");const top=$comment.offsetTop-$header.offsetHeight-15;window.scrollTo({top:top})})),Joe.isMobile)return;const $asideEl=$(".aside_operations"),$operateEl=$(".joe_detail__agree,.joe_detail__operate-share,.joe_detail__operate .joe_donate"),toggleAsideMenu=e=>{$(".joe_post")[0].getBoundingClientRect().left<75?($asideEl.hide(),$operateEl.show()):($asideEl.show(),$operateEl.hide())};toggleAsideMenu(),window.addEventListener("resize",Utils.throttle(toggleAsideMenu),500)},initProgress(){if(!ThemeConfig.enable_progress_bar)return;$(window).off("scroll");const progress_bar=$(".joe_progress_bar");let win_h,body_h,sHeight;$(window).on("scroll",(function(e){e.stopPropagation(),win_h=$(window).height(),body_h=$("body").height(),sHeight=body_h-win_h,window.requestAnimationFrame((function(){const perc=Math.max(0,Math.min(1,$(window).scrollTop()/sHeight));var p;p=perc,progress_bar.css("width",100*p+"%")}))}))},initVideo(){if($(".joe_detail__article-video").length){const player=$(".joe_detail__article-video .play iframe").attr("data-player");$(".joe_detail__article-video .episodes .item").on("click",(function(e){e.stopPropagation(),$(this).addClass("active").siblings().removeClass("active");const url=$(this).attr("data-src");$(".joe_detail__article-video .play iframe").attr({src:player+url})})),$(".joe_detail__article-video .episodes .item").first().click()}},async jumpToComment(){if(ThemeConfig.enable_clean_mode||!ThemeConfig.enable_comment||"false"===PageAttrs.metas.enable_comment)return;const{cid:commentId="",p:postId=""}=Utils.getUrlParams();if(commentId){await Utils.sleep(1e3);try{const commentEl=document.getElementsByTagName("halo-comment");if(!commentEl)return;const el=$(commentEl[0].shadowRoot.getElementById("halo-comment")).find("#comment-"+commentId);if(!el)return;const offsetTop=el.offset().top-50;window.scrollTo({top:offsetTop});const el_comment=el.find(".markdown-content").eq(0);el_comment.addClass("blink"),await Utils.sleep(2e3),el_comment.removeClass("blink"),window.history.replaceState(null,null,postId?`?p=${postId}`:location.origin+location.pathname),tocbot.refresh()}catch(error){console.info(error)}}}};!function(){const omits=["jumpToComment"];document.addEventListener("DOMContentLoaded",(function(){Object.keys(postContext).forEach(c=>!omits.includes(c)&&"function"==typeof postContext[c]&&postContext[c]())})),window.addEventListener("load",(function(){1===omits.length?postContext[omits[0]]():omits.forEach(c=>"loadingBar"!==c&&postContext[c]&&postContext[c]())}))}();